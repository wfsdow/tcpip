
[TOC]

# tcpip知识分享

## tcpip简介
TCPIP是指一个网络传输协议族，其中有若干个协议。核心的协议是tcp协议和ip协议。协议族采用分层架构，每一层负责有自己对应的功能。典型的分层如下：
每一层将上一层传入的数据包装一层，加上对应的首部，然后传给下一层。

## http的数据是如何传输的
![http传输](./assets/http传输.png)
可以看到http数据，从以太主机传输到另一台主机的过程中，数据经过一层层的处理，然后传到网络中。数据通过网络到达另一台主机后，以相反的顺序通过每一层。每经过一层就会把之前在这一层添加的信息给去除。当数据到达应用程序时，就恢复成最原始的数据了。

对用户来说，他不用关心数据的传输细节。只需要将数据传给tcp模块，剩下的操作都会由操作系统处理好。

![数据的逐层处理](./assets/UDP_encapsulation.svg)

<!-- 1. 应用层产生的http数据
2. 传输层以应用层的数据作为基础，添加了tcp相关的信息(tcp首部)。
3. 网络层在传输层的数据前面添加了, ip协议相关的信息(ip首部)
4. 链路层在网络层的数据前面添加了以太网相关的信息(以太网首部) -->

## 链路层（以太网）
数据最终是要转化为电信号，通过网线进行传输的。现在最常用的局域网结构就是以太网了。
* 以太网使用带冲突检测的载波侦听多路访问（CSMA/CD）。这项技术规定了多台计算机共享一个通道的方法。
* 载波侦听（英语：Carrier Sense）指任何连接到介质的设备在欲发送帧前，必须对介质进行侦听，当确认其空闲时，才可以发送
* 多路访问（英语：Multiple Access）指多个设备可以同时访问介质，一个设备发送的帧也可以被多个设备接收。

### 以太网帧数据结构
![数据的逐层处理](./assets/以太网帧.png)
目标地址和源地址就是网卡的mac地址。
* 以太网帧为什么有最大长度和最小长度的限制？
1. 最小长度是为了使以太网中两台距离最远的主机，在发送数据时，如果发生冲突可以被监听到。
2. 最大长度是为了单一主机占用信道时间过长。

* 为什么有了mac地址，还需要ip地址。
1. IP地址是逻辑地址寻址，工作在网络层，具有全网范围内的寻址能力，可以快速定位目标地址所在的网络
2. MAC地址是物理地址寻址，工作在数据链路层，要将数据包发给对方必须知道对方的MAC地址，因为主机的以太网网卡只能识别MAC地址。mac地址不能跨局域网
<!-- * 只靠mac地址，两台主机能够通信吗？
不能。如果两台主机在同一个局域网内，则可以直接发送消息。而如果在两个不同的局域网内，则无法通信。mac地址无法跨局域网。 -->

## IP层
Internet中的主机都有一个唯一的id。这个id就是ip地址。ip地址32位，使用点分十进制的形式表示。 每一段8位，共4段。每段之间使用.分割。
IP地址= 网络号 + 主机号。
网络号使用子网掩码识别出来。将ip地址与子网掩码做与运算，得到的就是网络号。
判断通信的主机是在同一个局域网中，还是在广域网中，就是比较两个主机的网络号是不是相同

### IP首部
<table class="wikitable" style="text-align:center">
<tbody><tr>
<th width="4%">位偏移
</th>
<th colspan="4" width="12%">0–3
</th>
<th colspan="4" width="12%">4–7
</th>
<th colspan="6" width="24%">8–13
</th>
<th colspan="2" width="6%">14-15
</th>
<th colspan="3" width="9%">16–18
</th>
<th colspan="13" width="39%">19–31
</th></tr>
<tr>
<th>0
</th>
<td colspan="4">版本
</td>
<td colspan="4">首部长度
</td>
<td colspan="6">区分服务
</td>
<td colspan="2"><a href="/w/index.php?title=%E6%98%BE%E5%BC%8F%E6%8B%A5%E5%A1%9E%E9%80%9A%E5%91%8A&amp;action=edit&amp;redlink=1" class="new" title="显式拥塞通告（页面不存在）">显式拥塞通告</a>
</td>
<td colspan="16">全长
</td></tr>
<tr>
<th>32
</th>
<td colspan="16">标识符
</td>
<td colspan="3">标志
</td>
<td colspan="13">分片偏移
</td></tr>
<tr>
<th>64
</th>
<td colspan="8"><a href="/wiki/%E5%AD%98%E6%B4%BB%E6%99%82%E9%96%93" title="存活时间">存活时间</a>
</td>
<td colspan="8"><a href="/wiki/%E5%8D%8F%E8%AE%AE" class="mw-disambig" title="协议">协议</a>
</td>
<td colspan="16">首部检验和
</td></tr>
<tr>
<th>96
</th>
<td colspan="32">源IP地址
</td></tr>
<tr>
<th>128
</th>
<td colspan="32">目的IP地址
</td></tr>
<tr>
<th>160
</th>
<td colspan="32" bgcolor="#FFBBBB">选项（如首部长度&gt;5）
</td></tr>
<tr>
<th>160<br>or<br>192+
</th>
<td colspan="32">&nbsp;<br>数据<br>&nbsp;
</td></tr></tbody></table>

* 重点字段
    1. 全长。表示ip首部和数据部分，以字节为单位。
    2. 存活时间 TTL。表示可以经过几次路由器跳转
    3. 分片偏移。  IP分片

### ARP
* 以太网协议模块接收到的ip数据中，只包含目标主机的ip地址。需要一种方法，根据目标主机的ip地址获取其mac地址。
* 这就是ARP(address resolution protocol)地址解析协议要做的事。在主机发送帧前将目标ip地址转换为mac地址。






## 从ping开始说起
我们平常经常使用ping来测试电脑是否联网，或者某台主机是否在线都会使用ping来进行测试。那ping的基本原理是什么呢？发送一个echo请求，接收一个echo应答。
* 抓包内容

### 网络分层
可以看到抓到的数据包，被wireshark分为了三类信息:
1. 以太网帧信息
2. ip首部信息
3. icmp信息
这三类信息，每一个都对应了TCPIP中的一个分层。



* 发送ICMP数据报实现。ICMP数据报是由IP数据报承载的。

### IP数据报

### ICMP数据报



## 数据是怎么在网线上传播的





## 背景介绍
### wireshark的基本原理